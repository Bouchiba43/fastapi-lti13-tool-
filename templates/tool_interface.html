<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.context_title }} - LTI Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .welcome-text {
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #2c3e50;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 25px;
        }
        
        .tool-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e74c3c;
        }
        
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .activity-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .activity-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .activity-description {
            opacity: 0.9;
            line-height: 1.5;
        }
        
        .quiz-container {
            background: rgba(52, 152, 219, 0.1);
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #3498db;
            margin-top: 20px;
        }
        
        .question {
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .options {
            list-style: none;
        }
        
        .option {
            margin-bottom: 10px;
        }
        
        .option input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .option label {
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s ease;
        }
        
        .option label:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .instructor-panel {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }
        
        .instructor-title {
            color: #e74c3c;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with user information -->
        <div class="header">
            <div class="welcome-text">Welcome to {{ user.context_title or "LTI Learning Tool" }}</div>
            <div class="user-info">
                <div class="info-card">
                    <div class="info-label">Name</div>
                    <div class="info-value">{{ user.full_name or "Unknown User" }}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">User ID</div>
                    <div class="info-value">{{ user.user_id }}</div>
                </div>
                {% if user.email %}
                <div class="info-card">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ user.email }}</div>
                </div>
                {% endif %}
                <div class="info-card">
                    <div class="info-label">Roles</div>
                    <div class="info-value">{{ user.roles|join(', ') if user.roles else 'Student' }}</div>
                </div>
                {% if user.context_title %}
                <div class="info-card">
                    <div class="info-label">Course</div>
                    <div class="info-value">{{ user.context_title }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Main tool content -->
        <div class="main-content">
            <div class="tool-section">
                <h2 class="section-title">Learning Activities</h2>
                <div class="activity-grid">
                    <div class="activity-card" onclick="startQuiz()">
                        <div class="activity-title">üìù Interactive Quiz</div>
                        <div class="activity-description">
                            Test your knowledge with this interactive quiz. Multiple choice questions with immediate feedback and grade passback to Moodle.
                        </div>
                    </div>
                    <div class="activity-card" onclick="openAssignment()">
                        <div class="activity-title">üìÑ Assignment Submission</div>
                        <div class="activity-description">
                            Submit your assignment and receive automated feedback on your work with progress tracking.
                        </div>
                    </div>
                    <div class="activity-card" onclick="viewProgress()">
                        <div class="activity-title">üìä Progress Tracker</div>
                        <div class="activity-description">
                            Track your learning progress and see detailed analytics of your performance across all activities.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Section -->
            <div id="quiz-section" class="tool-section hidden">
                <h2 class="section-title">LTI Knowledge Quiz</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="quiz-progress"></div>
                </div>
                
                <div class="quiz-container">
                    <div class="question" id="question-1">
                        <div class="question-text">1. What does LTI stand for?</div>
                        <ul class="options">
                            <li class="option">
                                <input type="radio" id="q1-a" name="question1" value="a">
                                <label for="q1-a">Learning Technology Integration</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q1-b" name="question1" value="b">
                                <label for="q1-b">Learning Tools Interoperability</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q1-c" name="question1" value="c">
                                <label for="q1-c">Learning Transfer Interface</label>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="question hidden" id="question-2">
                        <div class="question-text">2. Which protocol does LTI primarily use for authentication?</div>
                        <ul class="options">
                            <li class="option">
                                <input type="radio" id="q2-a" name="question2" value="a">
                                <label for="q2-a">OAuth 1.0a</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q2-b" name="question2" value="b">
                                <label for="q2-b">SAML 2.0</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q2-c" name="question2" value="c">
                                <label for="q2-c">JWT Tokens</label>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="question hidden" id="question-3">
                        <div class="question-text">3. What is the primary purpose of LTI?</div>
                        <ul class="options">
                            <li class="option">
                                <input type="radio" id="q3-a" name="question3" value="a">
                                <label for="q3-a">To replace Learning Management Systems</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q3-b" name="question3" value="b">
                                <label for="q3-b">To integrate external tools with LMS platforms</label>
                            </li>
                            <li class="option">
                                <input type="radio" id="q3-c" name="question3" value="c">
                                <label for="q3-c">To create standalone educational software</label>
                            </li>
                        </ul>
                    </div>
                    
                    <button id="quiz-btn" class="btn btn-success" onclick="nextQuestion()">Next Question</button>
                    <button class="btn btn-danger hidden" onclick="cancelQuiz()" id="cancel-btn">Cancel Quiz</button>
                </div>
                
                <div id="quiz-result" class="hidden"></div>
            </div>
            
            <!-- Progress Section -->
            <div id="progress-section" class="tool-section hidden">
                <h2 class="section-title">Your Learning Progress</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%;"></div>
                </div>
                <p id="progress-text">Loading your progress...</p>
                
                <div id="progress-details" class="activity-grid" style="margin-top: 20px;">
                    <!-- Progress details will be loaded here -->
                </div>
                
                <button class="btn" onclick="hideProgress()">Back to Activities</button>
            </div>
        </div>
        
        <!-- Instructor Panel (only visible to instructors) -->
        {% if user.is_instructor %}
        <div class="instructor-panel">
            <div class="instructor-title">üë®‚Äçüè´ Instructor Panel</div>
            <p>As an instructor, you have access to additional features:</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="viewAllStudents()">üë• View All Students</button>
                <button class="btn btn-success" onclick="exportGrades()">üìä Export Grades</button>
                <button class="btn btn-success" onclick="manageContent()">‚öôÔ∏è Manage Content</button>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- JavaScript for interactivity -->
    <script>
        let currentQuestion = 1;
        let totalQuestions = 3;
        let quizAnswers = {};
        const sessionToken = '{{ session_token }}';
        const supportsGrading = {{ 'true' if launch_data.lis_outcome_service_url else 'false' }};
        
        // API base URL
        const API_BASE = '/api';
        
        function startQuiz() {
            document.getElementById('quiz-section').classList.remove('hidden');
            document.getElementById('progress-section').classList.add('hidden');
            currentQuestion = 1;
            quizAnswers = {};
            updateQuizProgress();
            
            // Show first question
            document.getElementById('question-1').classList.remove('hidden');
            document.getElementById('quiz-btn').textContent = 'Next Question';
            document.getElementById('quiz-btn').onclick = nextQuestion;
            document.getElementById('cancel-btn').classList.add('hidden');
        }
        
        function nextQuestion() {
            const currentAnswer = document.querySelector(`input[name="question${currentQuestion}"]:checked`);
            if (!currentAnswer) {
                alert('Please select an answer before continuing.');
                return;
            }
            
            quizAnswers[`question${currentQuestion}`] = currentAnswer.value;
            
            document.getElementById(`question-${currentQuestion}`).classList.add('hidden');
            currentQuestion++;
            
            if (currentQuestion <= totalQuestions) {
                document.getElementById(`question-${currentQuestion}`).classList.remove('hidden');
                updateQuizProgress();
                
                if (currentQuestion === totalQuestions) {
                    document.getElementById('quiz-btn').textContent = 'Submit Quiz';
                    document.getElementById('quiz-btn').onclick = submitQuiz;
                    document.getElementById('cancel-btn').classList.remove('hidden');
                }
            }
        }
        
        function updateQuizProgress() {
            const progress = (currentQuestion / totalQuestions) * 100;
            document.getElementById('quiz-progress').style.width = progress + '%';
        }
        
        async function submitQuiz() {
            // Calculate score
            let score = 0;
            const correctAnswers = {
                'question1': 'b', // Learning Tools Interoperability
                'question2': 'a', // OAuth 1.0a
                'question3': 'b'  // To integrate external tools with LMS platforms
            };
            
            for (let q in correctAnswers) {
                if (quizAnswers[q] === correctAnswers[q]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const gradePercentage = percentage / 100; // Convert to 0-1 scale for LTI
            
            // Hide quiz questions
            document.getElementById(`question-${currentQuestion}`).classList.add('hidden');
            document.getElementById('quiz-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'none';
            
            // Show results
            const resultDiv = document.getElementById('quiz-result');
            resultDiv.innerHTML = `
                <div class="status-message ${percentage >= 70 ? 'success' : 'error'}">
                    <h3>üéØ Quiz Results</h3>
                    <p>You scored <strong>${score} out of ${totalQuestions}</strong> questions correctly (<strong>${percentage.toFixed(1)}%</strong>)</p>
                    <p>${percentage >= 70 ? 'üéâ Congratulations! You passed!' : 'üìö Please review the material and try again.'}</p>
                    ${supportsGrading ? '<p>‚úÖ Your grade has been sent back to Moodle automatically.</p>' : '<p>‚ÑπÔ∏è Grade passback is not available for this launch.</p>'}
                </div>
                <button class="btn" onclick="resetQuiz()">üîÑ Take Quiz Again</button>
                <button class="btn btn-success" onclick="hideQuiz()">üìö Back to Activities</button>
            `;
            resultDiv.classList.remove('hidden');
            
            // Save progress to server
            try {
                await saveProgress({
                    activity_id: 'lti_quiz',
                    activity_type: 'quiz',
                    progress_percentage: 100.0,
                    status: 'completed',
                    score: gradePercentage,
                    attempts: 1,
                    time_spent: 300, // Estimated 5 minutes
                    data: {
                        answers: quizAnswers,
                        correct_answers: score,
                        total_questions: totalQuestions
                    }
                });
                
                // Submit grade back to LMS (if supported)
                if (supportsGrading) {
                    await submitGrade({
                        grade: gradePercentage,
                        activity_name: 'LTI Knowledge Quiz',
                        comment: `Quiz completed with ${percentage.toFixed(1)}% (${score}/${totalQuestions} correct)`
                    });
                }
            } catch (error) {
                console.error('Error saving quiz results:', error);
            }
        }
        
        function resetQuiz() {
            currentQuestion = 1;
            quizAnswers = {};
            
            // Hide result and show first question
            document.getElementById('quiz-result').classList.add('hidden');
            document.getElementById('question-1').classList.remove('hidden');
            
            // Reset buttons
            document.getElementById('quiz-btn').style.display = 'inline-block';
            document.getElementById('quiz-btn').textContent = 'Next Question';
            document.getElementById('quiz-btn').onclick = nextQuestion;
            document.getElementById('cancel-btn').classList.add('hidden');
            
            // Reset progress
            document.getElementById('quiz-progress').style.width = '33.33%';
            
            // Clear all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Hide other questions
            for (let i = 2; i <= totalQuestions; i++) {
                document.getElementById(`question-${i}`).classList.add('hidden');
            }
        }
        
        function cancelQuiz() {
            resetQuiz();
            hideQuiz();
        }
        
        function hideQuiz() {
            document.getElementById('quiz-section').classList.add('hidden');
        }
        
        function openAssignment() {
            alert('üìù Assignment feature would open here. This could include:\n\n‚Ä¢ File upload functionality\n‚Ä¢ Text submission areas\n‚Ä¢ Rubric-based grading\n‚Ä¢ Peer review capabilities\n‚Ä¢ Plagiarism detection\n\nThis is a demo - implement based on your needs!');
        }
        
        async function viewProgress() {
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('quiz-section').classList.add('hidden');
            
            try {
                // Load user progress from API
                const response = await apiCall('/user/progress');
                const progressData = await response.json();
                
                // Calculate overall progress
                const totalActivities = progressData.length;
                const completedActivities = progressData.filter(p => p.status === 'completed').length;
                const overallProgress = totalActivities > 0 ? (completedActivities / totalActivities) * 100 : 0;
                
                // Update progress bar
                document.getElementById('overall-progress').style.width = overallProgress + '%';
                document.getElementById('progress-text').textContent = 
                    `You have completed ${completedActivities} out of ${totalActivities} activities (${overallProgress.toFixed(1)}%)`;
                
                // Display detailed progress
                const detailsDiv = document.getElementById('progress-details');
                detailsDiv.innerHTML = progressData.map(activity => `
                    <div class="info-card">
                        <div class="info-label">${activity.activity_id.replace('_', ' ').toUpperCase()}</div>
                        <div class="info-value">
                            <div>Progress: ${activity.progress_percentage.toFixed(1)}%</div>
                            <div>Status: ${activity.status}</div>
                            ${activity.score ? `<div>Score: ${(activity.score * 100).toFixed(1)}%</div>` : ''}
                            <div>Time: ${Math.floor(activity.time_spent / 60)}m ${activity.time_spent % 60}s</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading progress:', error);
                document.getElementById('progress-text').textContent = 'Error loading progress data';
            }
        }
        
        function hideProgress() {
            document.getElementById('progress-section').classList.add('hidden');
        }
        
        // Instructor functions
        async function viewAllStudents() {
            try {
                const response = await apiCall('/tool/student-progress');
                const students = await response.json();
                
                let content = 'Student Progress Overview:\n\n';
                students.forEach((student, index) => {
                    content += `${index + 1}. ${student.name} (${student.overall_progress.toFixed(1)}%)\n`;
                    content += `   Email: ${student.email}\n`;
                    content += `   Activities: ${student.activities.length} total\n\n`;
                });
                
                alert(content);
            } catch (error) {
                alert('Feature available in full implementation. Would show detailed student progress analytics.');
            }
        }
        
        function exportGrades() {
            alert('üìä Export Grades feature would:\n\n‚Ä¢ Generate CSV/Excel reports\n‚Ä¢ Include detailed analytics\n‚Ä¢ Provide grade distribution charts\n‚Ä¢ Export to various LMS formats\n‚Ä¢ Schedule automated reports\n\nThis is a demo - implement based on your needs!');
        }
        
        function manageContent() {
            alert('‚öôÔ∏è Content Management would include:\n\n‚Ä¢ Quiz/assignment creation tools\n‚Ä¢ Content library management\n‚Ä¢ Activity configuration\n‚Ä¢ Grading rubric setup\n‚Ä¢ Student group management\n‚Ä¢ Analytics dashboard\n\nThis is a demo - implement based on your needs!');
        }
        
        // API Helper Functions
        async function apiCall(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${sessionToken}`,
                    'Content-Type': 'application/json'
                }
            };
            
            return fetch(`${API_BASE}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });
        }
        
        async function saveProgress(progressData) {
            try {
                const response = await apiCall('/tool/save-progress', {
                    method: 'POST',
                    body: JSON.stringify(progressData)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Progress saved successfully');
                    return await response.json();
                } else {
                    console.error('‚ùå Failed to save progress');
                    throw new Error('Failed to save progress');
                }
            } catch (error) {
                console.error('Error saving progress:', error);
                throw error;
            }
        }
        
        async function submitGrade(gradeData) {
            try {
                const response = await apiCall('/tool/submit-grade', {
                    method: 'POST',
                    body: JSON.stringify(gradeData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    console.log('‚úÖ Grade submitted successfully to LMS');
                    return result;
                } else {
                    console.warn('‚ö†Ô∏è Grade submission warning:', result.message);
                    return result;
                }
            } catch (error) {
                console.error('‚ùå Error submitting grade:', error);
                throw error;
            }
        }
        
        // Initialize the tool
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ LTI Tool initialized');
            console.log('User:', '{{ user.full_name }}');
            console.log('Context:', '{{ user.context_title }}');
            console.log('Grade passback supported:', supportsGrading);
            
            // Load initial user data
            loadUserData();
        });
        
        async function loadUserData() {
            try {
                const response = await apiCall('/user/me');
                if (response.ok) {
                    const userData = await response.json();
                    console.log('üë§ User data loaded:', userData);
                } else {
                    console.error('‚ùå Failed to load user data');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
    </script>
</body>
</html>
